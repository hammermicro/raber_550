---
title: "Analyses_and_Plots"
author: "Austin Hammer"
date: "11/5/2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
library("ggplot2")
library("dplyr")
library("vegan")
library("DESeq2")
library("knitr")


```{r make_phyloseq_object, echo=FALSE}
library("readxl")
library("phyloseq")
seqtab <- readRDS("C:/Users/hammera/Desktop/raber_550/data/reads_290190_seqtab_final.rds")
seqtab.taxa <- readRDS("C:/Users/hammera/Desktop/raber_550/data/reads_290190_taxa_final.rds")
seqtab <- (seqtab)
meta_data <- as.data.frame(read_excel("C:/Users/hammera/Desktop/raber_550/data/550_metadata_revised.xlsx"))
rownames(seqtab) <- meta_data$RaberSID
samples = sample_data(meta_data)
ASV = otu_table(seqtab, taxa_are_rows = FALSE)
TAX = tax_table(seqtab.taxa)
sample_names(samples) <- sample_names(ASV)
physeq = phyloseq(ASV, TAX, samples)
taxa_names(physeq) <- paste0("ASV", seq(ntaxa(physeq)))
physeq = subset_samples(physeq, sample_names(physeq) != "93")
physeq = subset_samples(physeq, sample_names(physeq) != "59")
physeq1 <- physeq
sample_data(physeq1)$Radiated <- get_variable(physeq1, "Treatment") %in% c("25","50","200")
```

```{r alphadiv}
## While the p-value for ANOVA of alphadiv~Treatment isn't extremely low (Pr(>F)~0.13), Shannon~Treatment*Sex (Pr(>F)~0.06), Observed~Treatment (Pr(>F)~0.06) it might be useful to briefly mention this in light of Keaton's previous analysis which showed an increase in alphadiv associated with increased radiation exposure. However, this test also functions with the assumptions necessary for running ANOVA about which I am not certain.
## Should maybe look at mean #ofgenera observed as a function of radiation level. Considering the low count #s post-glom with phyloseq, is this going to be descriptive or meaningful
library("phyloseq")
sample_data(physeq1)$Alphadiv <- estimate_richness(physeq1, split=TRUE, measures=c("Shannon"))
anova_df <- data.frame(sample_data(physeq1))
aov_results <- aov(as.matrix(Alphadiv) ~ Treatment*Sex, data=anova_df)
anova_results <- anova(aov_results)
some_plot <- boxplot((as.matrix(Alphadiv))~Treatment, data=anova_df)
print(anova_results)
```

```{r enfit, echo=FALSE}
## 
library("vegan")
treatment.env <- data.frame(sample_data(physeq1))
physeq1.rda <- rda(otu_table(physeq1)~Sex+Treatment+FSTTimeImmobile+NOObjpref+OFCentDur1+FCCuedFrzTone+OFTotDistDay1, data=treatment.env)
##physeq1.enfit <- envfit(physeq1.rda~Sex+Treatment+FSTTimeImmobile+NOObjpref+OFCentDur1+FCCuedFrzTone+OFTotDistDay1, data=(treatment.env), perm=5000)
##plot(physeq1.rda, type="t")
physeq_ordination <- decorana(data.frame(otu_table(physeq1)))
physeq_enfit <- envfit(physeq_ordination~Treatment*Sex+FSTTimeImmobile+NOObjpref+OFCentDur1+FCCuedFrzTone+OFTotDistDay1, data=treatment.env, perm=1000)
plot(physeq_ordination)
plot(physeq_enfit)
#plot(physeq1.enfit)
```

```{r nmds_different_axes}
set.seed(1)
physeq1 <- rarefy_even_depth(physeq1, rngseed=TRUE, verbose=FALSE)
physeq_nmds = metaMDS(otu_table(physeq1), distance="bray", k=4, trymax=1000, data=treatment.env)
nmds_table = scores(physeq_nmds, display="sites")
plot(nmds_table[,2], nmds_table[,3], main="Bray-Curtis Beta-div", xlab="NMDS1", ylab="NMDS3", pch=20, col=c("slateblue3", "tomato3", "darkolivegreen", "coral4"))
##This shows the ordination using different NMDS axes. These can be specified by performing metaMDS on the object otu_table and specifying k=(num of NMDS axes), then using the plot_ordination function with the phyloseq object, specifying colors and shapes based on metadata you want to visualize
physeq1.ord.plot <- plot_ordination(physeq1, physeq_nmds, type="samples", axes=c(1,3), color="Treatment", title="ByTreatment") + stat_ellipse(level=0.95)
print(physeq1.ord.plot)
physeq1 <- physeq

```



```{r bray_by_Sex_Treatment, echo=FALSE}
library("phyloseq")
physeq1.ord <- ordinate(physeq1, "NMDS", "jaccard")
sample_data(physeq1)$Treatment <- as.factor(sample_data(physeq1)$Treatment)
physeq1.ord.plot <- plot_ordination(physeq1, physeq1.ord, type="samples", color="Sex", title="BySex") + stat_ellipse(level=0.4)
plot(physeq1.ord.plot)
physeq1.ord.treatment <- plot_ordination(physeq1, physeq1.ord, type="samples", color="Treatment", title="ByTreatment", shape="Sex")
plot(physeq1.ord.treatment)
physeq1.ord.plot.treatment <- plot_ordination(physeq1, physeq1.ord, type="samples", color="Sex_Treatment", title="BySex_Treatment") + stat_ellipse(level=0.4)##optional parameter for any of the above plots + stat_ellipse(level=0.4)
plot(physeq1.ord.plot.treatment)
```

```{r adonis_results}
## Using adonis to evaluate the importance of covariates in explaining variation in the ordination produced using bray. Treatment*Sex has a large relative R2, and the Pr(>F) is quite low. 
library("phyloseq")
library("vegan")
set.seed(1)
physeq1 <- rarefy_even_depth(physeq1)
physeq1.dist <- vegdist(otu_table(physeq1), method="bray")
sampledf <- data.frame(sample_data(physeq1))
set.seed(1)
perm.results.treatment <- adonis(physeq1.dist ~ Treatment*Sex, data=sampledf, permutations=5000)
print(perm.results.treatment)
physeq1 <- physeq
```

```{r capscale_ordistep}
## We ran through possible permutations and options for model selection using AIC in ordistep after building a model in capscale. Results are available via mod. The best model found after running through covariate permutations was Treatment*Sex.
sampledf <- data.frame(sample_data(physeq1))
physeq1.capsca <- capscale(physeq1.dist ~ Treatment*Sex, sampledf, dist="bray")
set.seed(1)
mod <- ordistep(physeq1.capsca, perm.max = 5000, trace = T, direction = "both")
print(mod)
```

```{r betadispersion}
## The graphical results of this suggest that there might be a difference in mean betadispersion, with particularly low dispersion among the highly radiated groups. Is lower betadispersion associated with higher radiation levels? Would that suggest that there are more relatively limited conformations adopted by the murine gut microbiome in association with radiation?
## Do I need to correct for multiple pairwise comparisons?
treatments <- factor(sample_data(physeq1)$Treatment)
betadispersion <- betadisper(physeq1.dist, treatments, type=c("centroid"))
boxplot(betadispersion)
set.seed(1)
testbetad <- permutest(betadispersion, pairwise=TRUE, permutations=5000)
print(testbetad)
beta_disp_tukey_result <- TukeyHSD(betadispersion, ordered=FALSE, conf.level=0.95)
```

```{r deseq2_function}
library("phyloseq")
taxa_with_deseq <- function(treatdds.deseq, physeq1){ 
sigtab <- NULL
##treatdds = phyloseq_to_deseq2(phyloseq_object, ~"some_covariate")
treatdds.deseq = DESeq(treatdds)
res = results(treatdds.deseq, cooksCutoff=FALSE)
res = data.frame(res)
alpha = 0.1
remove_nas <- is.na(res$adj)
sigtab <- subset(res, remove_nas)
res <- subset(res, !is.na(res$padj))
sigtab <- subset(res, res$padj < alpha)
if (nrow(sigtab)>0){
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq1)[rownames(sigtab), ], "matrix"))
return(sigtab)
} else {
  return("No significant taxa were identified using the specified formula")
}
}

```

```{r ASV_analysis}
## This first step agglomerates to a chosen level, then you can use the workthrough below to continue the analysis
## Covariates = Sex+Treatment+FSTTimeImmobile+NOObjpref+OFCentDur1+FCCuedFrzTone+OFTotDistDay1
library(DESeq2)
set.seed(1)
physeq1<-physeq
phyloseq_object <- physeq1
physeq_genus <- tax_glom(physeq, taxrank="Genus")
##This is a basic workthrough that runs DESeq2 for analysis of taxa analysis. One thing that that I should consider is filtering the available taxa to so that only taxa that are present in 50% of samples or greater. This would eliminate this issue where differences are inflated by the presence of a bunch of zeros for a particular group. I think that effect could largely be driven by the Box covariate, which is possibly suggested in the adonis results as well.
## A couple limitations 
sigtab <- NULL
treatdds = phyloseq_to_deseq2(physeq_genus, ~Treatment)
treatdds.deseq = DESeq(treatdds)
res = results(treatdds.deseq, cooksCutoff=FALSE)
res = data.frame(res)
alpha = 0.1
remove_nas <- is.na(res$adj)
sigtab <- subset(res, remove_nas)
res <- subset(res, !is.na(res$padj))
sigtab <- subset(res, res$padj < alpha)
if (nrow(sigtab)>0){
sigtab = cbind(as(sigtab, "data.frame"), as(tax_table(physeq1)[rownames(sigtab), ], "matrix"))
print(sigtab)
} else {
  print("No significant taxa were identified using the specified formula")
}

## Generate a couple of sigtab tables that reflect significant taxa according to behavioral covariates and permutations of Treatment/Sex. Does Treatment*Sex include Treatment, Sex, and Treatment*Sex taxa? perform at each level and see
## After generating the taxa tables, see which taxa might be common between sets
## Get a feel for the taxa present by looking at microbes observed in Keaton's work, and what might have been observed elsewhere 

asv_table=(otu_table(physeq))
sample_data_to_smash=sample_data(physeq)
taxa_table_plus_metadata <- data.frame(cbind(data.frame(asv_table), data.frame(sample_data_to_smash)))
##plotting_taxa <- ggplot(taxa_table_plus_metadata, aes(x=Treatment, y=ASV92)) + geom_smooth()##+ geom_jitter() 
##plotting_taxa

```

```{r filter_taxa_chunk}
## this is an optional chunk of code to run if you want to filter taxa for only those that are reasonably abundant. In the case below taxa that show up more than three times in more than 10% of samples will be filtered
## Run the chunks above to set to the default settings using a variety of 
physeq1 = filter_taxa(physeq, function(x) sum(x > 3) > (0.1*length(x)), TRUE)
phyloseq_object <- physeq1
physeq_genus <- tax_glom(physeq, taxrank="Genus")

```

```{r ASV_by_OFTotDistDay1}
## DESeq2 analysis using the specified covariate (ASV level)
treatdds = phyloseq_to_deseq2(phyloseq_object, ~OFTotDistDay1)
## Generated table containing ASVs
OFTotDistDay1_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(OFTotDistDay1_ASVs)
## DESeq2 genus level analysis using OFTotDistDay1
treatdds = phyloseq_to_deseq2(physeq_genus, ~OFTotDistDay1)
## Genus level table
OFTotDistDay1_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(OFTotDistDay1_genus)
```

```{r ASV_by_FSTTimeImmobile}
## DESeq2 analysis using the specified covariate (ASV level)
treatdds = phyloseq_to_deseq2(phyloseq_object, ~FSTTimeImmobile)
## Generated table containing ASVs
FSTTimeImmobile_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(FSTTimeImmobile_ASVs)
## DESeq2 genus level analysis using FSTTimeImmobile
treatdds = phyloseq_to_deseq2(physeq_genus, ~FSTTimeImmobile)
## Genus level table
FSTTimeImmobile_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(FSTTimeImmobile_genus)
```

```{r ASV_by_NOObjpref}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~NOObjpref)
## Generated table containing ASVs
NOObjpref_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(NOObjpref_ASVs)
## DESeq2 analysis using NOObjpref
treatdds = phyloseq_to_deseq2(physeq_genus, ~NOObjpref)
## Genus level table
NOObjpref_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(NOObjpref_genus)

```

```{r ASV_by_OFCentDur1}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~OFCentDur1)
## Generated table containing ASVs
OFCentDur1_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(OFCentDur1_ASVs)
## DESeq2 analysis using OFCentDur1
treatdds = phyloseq_to_deseq2(physeq_genus, ~OFCentDur1)
## Genus level table
OFCentDur1_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(OFCentDur1_genus)
```

```{r ASV_by_Treatment}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~Treatment)
## Generated table containing ASVs
Treatment_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(Treatment_ASVs)
## DESeq2 analysis using Treatment
treatdds = phyloseq_to_deseq2(physeq_genus, ~Treatment)
## Genus level table
Treatment_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(Treatment_genus)
## The Anaeroplasma identified in the genus level analysis
asv_table=(otu_table(physeq_genus))
sample_data_to_smash=sample_data(physeq_genus)
taxa_table_plus_metadata <- data.frame(cbind(data.frame(asv_table), data.frame(sample_data_to_smash)))
plotting_taxa <- ggplot(taxa_table_plus_metadata, aes(x=Treatment, y=ASV656))  + geom_smooth() + geom_jitter()
plotting_taxa


```

```{r ASV_by_Sex}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~Sex)
## Generated table containing ASVs
Sex_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(Sex_ASVs)
## DESeq2 analysis using Sex
treatdds = phyloseq_to_deseq2(physeq_genus, ~Sex)
## Genus level table
Sex_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(Sex_genus)
```

```{r ASV_by_Treatment_interaction_Sex}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~Treatment*Sex)
## Generated table containing ASVs
Treatment_Sex_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(Treatment_Sex_ASVs)
## DESeq2 analysis using Treatment*Sex
treatdds = phyloseq_to_deseq2(physeq_genus, ~Treatment*Sex)
## Genus level table
Treatment_Sex_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(Treatment_Sex_genus)
```

```{r ASV_by_FCcuedFrzTone}
## Convert to deseq2 object using the specified covariate
treatdds = phyloseq_to_deseq2(phyloseq_object, ~FCCuedFrzTone)
## Generated table containing ASVs
FCCuedFrzTone_ASVs <- taxa_with_deseq(treatdds, physeq1)
print(FCCuedFrzTone_ASVs)
## DESeq2 analysis using Treatment*Sex
treatdds = phyloseq_to_deseq2(physeq_genus, ~FCCuedFrzTone)
## Genus level table
FCCuedFrzTone_genus <- taxa_with_deseq(treatdds, physeq_genus)
print(FCCuedFrzTone_genus)

```




```{r correl_taxa_and_covariates}

testing_correlate_function = correlate_taxa(physeq_genus)
## The function below takes a phyloseq object, extracts relevant data, then performs a correlation test using Kendall's tau if you want to use a different method for correlation analysis configure it using method in does_it_correlate
correlate_taxa <- function(phyloseq_object){
require("phyloseq")
#normalize read counts
#phyloseq_object = transform_sample_counts(phyloseq_object, function(y) y / sum(y))
#extract otu table for creation of big df
ASVs_for_analysis <- otu_table(phyloseq_object)
#extract metadata
sample_metadata <- sample_data(phyloseq_object)
#Get a taxa table (if you need it for later analysis)
taxa_info_table <- tax_table(phyloseq_object)
#combine otu_table and treatment info into one df
super_cor_df <- cbind(ASVs_for_analysis, sample_metadata)
#save values in this one
#colnames(place_to_store_df) <- (c("ASV", "saved p-value"))
#loop through the super_df, test each taxa for correlation, save the p-value and ASV in place_to_store_df, and return it after analysis is finished
for (i in 1:ncol(otu_table(phyloseq_object))){
does_it_correlate <- cor.test(c(super_cor_df[,i]), c(super_cor_df$Treatment), method=(c("kendall")))
place_to_store_df <- rbind(place_to_store_df, c((colnames(otu_table(phyloseq_object)[,i])), does_it_correlate[["p.value"]]))
subsetting_vec = !is.na(place_to_store_df[,2])
place_to_store_df = subset(place_to_store_df, subsetting_vec)
}
colnames(place_to_store_df) <- (c("ASV", "saved p-value"))
adjusted_pvals <- p.adjust(as.numeric(place_to_store_df[,2]), method=c("fdr"))
place_to_store_df$adjusted_pvals <- adjusted_pvals
return(place_to_store_df)
}

hist(as.numeric(place_to_store_df[,2]))
adjusted_pvals_from_corr_test = p.adjust(as.numeric(place_to_store_df[,2]), method=c("fdr"))
hist(adjusted_pvals_from_corr_test)




```





































